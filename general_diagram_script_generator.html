<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Sequential Diagram</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: auto;
        }
        
        .container {
            min-width: 1400px;
            margin: 0 auto;
            position: relative;
            background: linear-gradient(120deg, #181c2a 0%, #232323 100%);
            border-radius: 0 0 30px 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        }
        
        /* Centered Initial Load Section */
        .initial-load-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .upload-area {
            background: rgba(20, 20, 20, 0.9);
            padding: 40px;
            border-radius: 15px;
            border: 2px dashed #666;
            max-width: 600px;
            width: 100%;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .upload-area.dragover {
            border-color: #4a9eff;
            background: rgba(74, 158, 255, 0.1);
        }
        
        .upload-area h3 {
            margin: 0 0 20px 0;
            font-size: 24px;
            color: #ffd43b;
            text-align: center;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 20px auto;
            padding: 15px 30px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 500;
        }
        
        .upload-btn:hover {
            background: #2a2a2a;
            border-color: #666;
        }
        
        .sample-download {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        
        .sample-download h4 {
            margin: 0 0 10px 0;
            color: #ffd43b;
            font-size: 14px;
        }
        
        .sample-download pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
            color: #e0e0e0;
            margin: 10px 0;
        }
        
        .sample-download a {
            color: #4a9eff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .sample-download a:hover {
            text-decoration: underline;
        }
        
        /* Fixed Controls for when diagram is loaded */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.97);
            padding: 18px 20px;
            border-radius: 14px;
            border: 1.5px solid #333;
            z-index: 1000;
            min-width: 220px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            display: none;
        }
        
        .controls.visible {
            display: block;
        }
        
        .controls h3 {
            margin: 0 0 10px 0;
            font-size: 17px;
            color: #ffd43b;
        }
        
        .controls button {
            display: block;
            width: 100%;
            margin: 7px 0;
            padding: 10px 0;
            background: linear-gradient(90deg, #232323 60%, #ffd43b22 100%);
            color: #fff;
            border: 1.5px solid #444;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .controls button:hover {
            background: #ffd43b33;
            border-color: #ffd43b;
            color: #222;
        }
        
        .controls button.active {
            background: #ffd43b;
            color: #222;
            border-color: #b19700;
        }
        
        /* Optimized Sequential Layout */
        svg {
            width: 100%;
            height: 800px;
            padding: 20px 0;
        }
        
        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .node:hover {
            filter: brightness(1.2);
        }
        
        .node-rect {
            fill: #2a2a2a;
            stroke-width: 3;
            transition: all 0.3s ease;
            rx: 16;
            filter: drop-shadow(0 2px 12px rgba(0,0,0,0.18));
        }
        
        .node:hover .node-rect {
            filter: drop-shadow(0 4px 24px rgba(255,212,59,0.18));
            stroke: #ffd43b;
        }
        
        .node-text {
            fill: #ffffff;
            font-size: 14px;
            font-weight: 500;
            pointer-events: none;
            text-anchor: middle;
        }
        
        .arrow {
            fill: none;
            stroke: #666;
            stroke-width: 3;
            marker-end: url(#arrowhead);
            opacity: 0.8;
        }
        
        .text-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 250px;
            background: rgba(20, 20, 20, 0.95);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #333;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            scroll-behavior: smooth;
        }
        
        .full-text {
            line-height: 1.8;
        }
        
        .full-text h4 {
            color: #ffd43b;
            margin: 0 0 15px 0;
            font-size: 18px;
            position: sticky;
            top: -25px;
            background: rgba(20, 20, 20, 0.95);
            padding: 10px 0;
        }
        
        .full-text p {
            margin: 0 0 15px 0;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .text-segment {
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .text-segment:hover {
            filter: brightness(1.2);
        }
        
        .text-segment.active {
            background: rgba(255, 212, 59, 0.4) !important;
            box-shadow: 0 0 10px rgba(255, 212, 59, 0.6);
            padding: 4px 8px;
            font-weight: 600;
        }
        
        .progress-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #333;
            font-size: 14px;
            color: #ffd43b;
            display: none;
        }
        
        .progress-indicator.visible {
            display: block;
        }
        
        .current-node {
            filter: drop-shadow(0 0 20px rgba(255, 212, 59, 0.6));
        }
        
        .full-text.highlighting p {
            opacity: 1;
        }
        
        .full-text.highlighting .text-segment {
            opacity: 0.4;
            transition: opacity 0.3s;
        }
        
        .full-text.highlighting .text-segment.active {
            opacity: 1 !important;
            background: rgba(255, 212, 59, 0.4) !important;
            box-shadow: 0 0 10px rgba(255, 212, 59, 0.6);
            padding: 4px 8px;
            font-weight: 600;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            color: #ff6b6b;
            font-size: 14px;
            text-align: center;
        }
        
        /* Hide initial section when diagram is loaded */
        .initial-load-section.hidden {
            display: none;
        }
        
        .drag-handle-bar {
            cursor: move;
            fill: url(#dragHandleGradient);
            stroke: #b19700;
            stroke-width: 1.5;
            opacity: 0.96;
        }
        
        .drag-handle-bar:hover {
            filter: brightness(1.1) drop-shadow(0 2px 8px #ffd43b88);
        }
        
        .drag-handle-icon {
            pointer-events: none;
            font-size: 15px;
            font-weight: bold;
            fill: #b19700;
            user-select: none;
        }
        
        /* Full script area as card */
        .text-display.full-text {
            background: rgba(30, 30, 30, 0.98);
            border-radius: 16px;
            border: 1.5px solid #444;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            padding: 32px 32px 24px 32px;
        }
    </style>
</head>
<body>
    <!-- Initial Load Section (Centered) -->
    <div class="initial-load-section" id="initialLoadSection">
        <div class="upload-area" id="uploadArea">
            <h3>Load Diagram Data</h3>
            <label for="jsonFile" class="upload-btn">Choose JSON File</label>
            <input type="file" id="jsonFile" class="file-input" accept=".json">
            
            <div class="sample-download">
                <h4>Sample JSON Structure:</h4>
                <pre><code>{
  "title": "AI Semantic Transformation",
  "sections": [
    {
      "id": "paragraph1",
      "name": "Foundation", 
      "color": "#4a9eff",
      "fillColor": "#1a5fb4"
    }
  ],
  "nodes": [
    {
      "id": "p1-1",
      "label": "Current AI\\nDiscourse",
      "section": "paragraph1",
      "step": 1
    }
  ],
  "arrows": [
    {"from": "p1-1", "to": "p1-2"}
  ],
  "fullText": [...]
}</code></pre>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" id="downloadSample">Download complete sample JSON</a>
                </div>
            </div>
            
            <div id="errorDisplay"></div>
        </div>
    </div>

    <!-- Main Diagram Container -->
    <div class="container">        
        <div class="progress-indicator" id="progressIndicator">
            <span id="currentStep">Navigate the flow →</span>
        </div>
        
        <div class="controls" id="controls">
            <h3>Controls</h3>
            <button id="toggleFullText">Show Full Script</button>
            <button id="exportMermaid">Export to Mermaid</button>
            <button id="loadNew">Load New File</button>
        </div>
        
        <button id="toggleControlsBtn" title="Show/Hide Controls" style="position:fixed;top:20px;right:20px;z-index:1100;background:#ffd43b;color:#222;border:none;border-radius:50%;width:44px;height:44px;box-shadow:0 2px 8px #0003;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;">
            ⚙️
        </button>
        
        <svg id="diagram">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                </marker>
                <linearGradient id="dragHandleGradient" x1="0" y1="0" x2="1" y2="0">
                    <stop offset="0%" stop-color="#ffe066"/>
                    <stop offset="100%" stop-color="#ffd43b"/>
                </linearGradient>
            </defs>
        </svg>
        
        <div id="fullTextDisplay" class="text-display full-text">
            <div id="textContent"></div>
        </div>
    </div>

    <script>
        class SequentialDiagramGenerator {
            constructor() {
                this.data = null;
                this.nodes = [];
                this.arrows = [];
                this.sections = [];
                this.fullTextVisible = false;
                this.currentStep = 0;
                this.activeSegment = null;
                this.controlsVisible = true;
                
                this.initializeEvents();
                this.generateSampleJSON();
            }
            
            initializeEvents() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('jsonFile');
                
                // File upload events
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
                uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
                
                // Control events
                document.getElementById('toggleFullText').addEventListener('click', () => this.toggleFullText());
                document.getElementById('exportMermaid').addEventListener('click', () => this.exportMermaid());
                document.getElementById('loadNew').addEventListener('click', () => this.loadNew());
                document.getElementById('downloadSample').addEventListener('click', (e) => this.downloadSample(e));
                // Controls toggle button
                const toggleBtn = document.getElementById('toggleControlsBtn');
                toggleBtn.addEventListener('click', () => this.toggleControls());
            }
            
            showError(message) {
                const errorDisplay = document.getElementById('errorDisplay');
                errorDisplay.innerHTML = `<div class="error-message">${message}</div>`;
                console.error('Diagram Error:', message);
            }
            
            clearError() {
                document.getElementById('errorDisplay').innerHTML = '';
            }
            
            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.add('dragover');
            }
            
            handleDrop(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.loadFile(files[0]);
                }
            }
            
            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.loadFile(file);
                }
            }
            
            loadFile(file) {
                this.clearError();
                
                if (!file.name.toLowerCase().endsWith('.json')) {
                    this.showError('Please select a JSON file.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        console.log('Loaded JSON data:', data);
                        this.loadData(data);
                    } catch (error) {
                        this.showError('Invalid JSON file: ' + error.message);
                    }
                };
                reader.onerror = () => {
                    this.showError('Error reading file.');
                };
                reader.readAsText(file);
            }
            
            loadData(data) {
                try {
                    this.data = data;
                    console.log('Processing data...');
                    
                    if (!this.validateData()) {
                        return;
                    }
                    
                    this.processData();
                    console.log('Generating diagram...');
                    this.generateDiagram();
                    this.generateFullText();
                    this.showInterface();
                    
                    console.log('Diagram loaded successfully!');
                } catch (error) {
                    this.showError('Error processing data: ' + error.message);
                    console.error('Load error:', error);
                }
            }
            
            validateData() {
                if (!this.data) {
                    this.showError('No data provided');
                    return false;
                }
                
                if (!this.data.nodes || !Array.isArray(this.data.nodes) || this.data.nodes.length === 0) {
                    this.showError('Data must contain a non-empty nodes array');
                    return false;
                }
                
                if (!this.data.sections || !Array.isArray(this.data.sections) || this.data.sections.length === 0) {
                    this.showError('Data must contain a non-empty sections array');
                    return false;
                }
                
                // Validate each node has required fields
                for (let i = 0; i < this.data.nodes.length; i++) {
                    const node = this.data.nodes[i];
                    if (!node.id) {
                        this.showError(`Node ${i} is missing required 'id' field`);
                        return false;
                    }
                    if (!node.label) {
                        this.showError(`Node ${node.id} is missing required 'label' field`);
                        return false;
                    }
                }
                
                // Validate each section has required fields
                for (let i = 0; i < this.data.sections.length; i++) {
                    const section = this.data.sections[i];
                    if (!section.id) {
                        this.showError(`Section ${i} is missing required 'id' field`);
                        return false;
                    }
                    if (!section.name) {
                        this.showError(`Section ${section.id} is missing required 'name' field`);
                        return false;
                    }
                }
                
                return true;
            }
            
            processData() {
                this.sections = this.data.sections.map(section => ({
                    ...section,
                    color: section.color || '#666',
                    fillColor: section.fillColor || '#2a2a2a'
                }));
                
                this.nodes = this.data.nodes.map((node, index) => ({
                    ...node,
                    step: node.step || index + 1,
                    x: node.x || this.optimizedLayoutX(index),
                    y: node.y || this.optimizedLayoutY(index),
                    width: node.width || 140,
                    height: node.height || 70,
                    section: node.section || 'default'
                }));
                
                this.arrows = this.data.arrows || this.generateAutoArrows();
                
                console.log('Processed data:', {
                    sections: this.sections,
                    nodes: this.nodes,
                    arrows: this.arrows
                });
            }
            
            // Improved layout for better sequential viewing
            optimizedLayoutX(index) {
                // Horizontal left-to-right layout
                const nodeSpacing = 220;
                const startX = 100;
                return startX + index * nodeSpacing;
            }
            
            optimizedLayoutY(index) {
                // All nodes on the same row
                return 200;
            }
            
            generateAutoArrows() {
                const arrows = [];
                for (let i = 0; i < this.nodes.length - 1; i++) {
                    arrows.push({
                        from: this.nodes[i].id,
                        to: this.nodes[i + 1].id
                    });
                }
                return arrows;
            }
            
            generateDiagram() {
                const svg = document.getElementById('diagram');
                svg.innerHTML = `
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                        </marker>
                        <linearGradient id="dragHandleGradient" x1="0" y1="0" x2="1" y2="0">
                            <stop offset="0%" stop-color="#ffe066"/>
                            <stop offset="100%" stop-color="#ffd43b"/>
                        </linearGradient>
                    </defs>
                `;
                
                // Create arrows
                this.arrows.forEach(arrow => {
                    const fromNode = this.nodes.find(n => n.id === arrow.from);
                    const toNode = this.nodes.find(n => n.id === arrow.to);
                    
                    if (!fromNode || !toNode) {
                        console.warn(`Arrow references missing node: ${arrow.from} -> ${arrow.to}`);
                        return;
                    }
                    
                    if (arrow.curved) {
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const midX = (fromNode.x + fromNode.width + toNode.x) / 2;
                        const midY = (fromNode.y + toNode.y) / 2 + 50;
                        
                        const d = `M ${fromNode.x + fromNode.width} ${fromNode.y + fromNode.height/2} 
                                  Q ${midX} ${midY} ${toNode.x} ${toNode.y + toNode.height/2}`;
                        
                        path.setAttribute('d', d);
                        path.setAttribute('class', 'arrow');
                        svg.appendChild(path);
                    } else {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('class', 'arrow');
                        line.setAttribute('x1', fromNode.x + fromNode.width);
                        line.setAttribute('y1', fromNode.y + fromNode.height/2);
                        line.setAttribute('x2', toNode.x);
                        line.setAttribute('y2', toNode.y + toNode.height/2);
                        svg.appendChild(line);
                    }
                });
                
                // Drag state
                let dragNode = null;
                let dragOffset = {x: 0, y: 0};
                let isDragging = false;
                
                // Mouse event handlers
                const onMouseMove = (e) => {
                    if (!isDragging || !dragNode) return;
                    const svgRect = svg.getBoundingClientRect();
                    const mouseX = e.clientX - svgRect.left;
                    const mouseY = e.clientY - svgRect.top;
                    dragNode.x = mouseX - dragOffset.x;
                    dragNode.y = mouseY - dragOffset.y;
                    this.generateDiagram(); // re-render for live feedback
                };
                const onMouseUp = (e) => {
                    if (isDragging) {
                        isDragging = false;
                        dragNode = null;
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }
                };
                
                // Create nodes
                this.nodes.forEach(node => {
                    const section = this.sections.find(s => s.id === node.section);
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    g.setAttribute('class', `node ${node.section}`);
                    g.setAttribute('data-id', node.id);
                    g.setAttribute('data-step', node.step);
                    
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('class', 'node-rect');
                    rect.setAttribute('x', node.x);
                    rect.setAttribute('y', node.y);
                    rect.setAttribute('width', node.width);
                    rect.setAttribute('height', node.height);
                    
                    if (section) {
                        rect.setAttribute('fill', section.fillColor);
                        rect.setAttribute('stroke', section.color);
                    }
                    g.appendChild(rect);
                    
                    // Full-width drag handle bar at the top
                    const handleHeight = 26;
                    const handleBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    handleBar.setAttribute('x', node.x);
                    handleBar.setAttribute('y', node.y);
                    handleBar.setAttribute('width', node.width);
                    handleBar.setAttribute('height', handleHeight);
                    handleBar.setAttribute('class', 'drag-handle-bar');
                    handleBar.addEventListener('mousedown', (evt) => {
                        if (evt.button !== 0) return;
                        evt.stopPropagation();
                        dragNode = node;
                        isDragging = true;
                        const svgRect = svg.getBoundingClientRect();
                        const mouseX = evt.clientX - svgRect.left;
                        const mouseY = evt.clientY - svgRect.top;
                        dragOffset.x = mouseX - node.x;
                        dragOffset.y = mouseY - node.y;
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });
                    g.appendChild(handleBar);
                    // Move icon/text in the handle
                    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    icon.setAttribute('x', node.x + node.width/2);
                    icon.setAttribute('y', node.y + handleHeight/2 + 5);
                    icon.setAttribute('text-anchor', 'middle');
                    icon.setAttribute('class', 'drag-handle-icon');
                    g.appendChild(icon);
                    // Multi-line text (shifted down for handle)
                    const lines = node.label.split('\n');
                    lines.forEach((line, i) => {
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('class', 'node-text');
                        text.setAttribute('x', node.x + node.width/2);
                        text.setAttribute('y', node.y + handleHeight + node.height/2 + (i - (lines.length - 1) / 2) * 16 - 10);
                        text.textContent = line;
                        g.appendChild(text);
                    });
                    // Node click (existing, for highlight)
                    g.addEventListener('click', (evt) => this.handleNodeClick(node));
                    svg.appendChild(g);
                });
            }
            
            generateFullText() {
                const textContent = document.getElementById('textContent');
                textContent.innerHTML = '';
                
                if (!this.data.fullText || !Array.isArray(this.data.fullText)) {
                    console.log('No fullText data provided');
                    return;
                }
                
                this.data.fullText.forEach(paragraph => {
                    const p = document.createElement('p');
                    p.id = paragraph.id;
                    
                    if (paragraph.segments && Array.isArray(paragraph.segments)) {
                        paragraph.segments.forEach(segment => {
                            const span = document.createElement('span');
                            span.className = `text-segment segment-${segment.nodeId}`;
                            span.setAttribute('data-node', segment.nodeId);
                            span.textContent = segment.text;
                            
                            const node = this.nodes.find(n => n.id === segment.nodeId);
                            const section = this.sections.find(s => s.id === node?.section);
                            if (section) {
                                span.style.backgroundColor = `${section.color}33`;
                            }
                            
                            span.addEventListener('click', () => {
                                const node = this.nodes.find(n => n.id === segment.nodeId);
                                if (node) this.handleNodeClick(node);
                            });
                            
                            p.appendChild(span);
                            if (segment !== paragraph.segments[paragraph.segments.length - 1]) {
                                p.appendChild(document.createTextNode(' '));
                            }
                        });
                    }
                    
                    textContent.appendChild(p);
                });
            }
            
            handleNodeClick(node) {
                this.currentStep = node.step;
                this.updateProgress();
                
                document.querySelectorAll('.text-segment').forEach(segment => {
                    segment.classList.remove('active');
                });
                
                if (this.fullTextVisible) {
                    const segment = document.querySelector(`[data-node="${node.id}"]`);
                    if (segment) {
                        segment.classList.add('active');
                        this.activeSegment = segment;
                        
                        document.getElementById('fullTextDisplay').classList.add('highlighting');
                        segment.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
            
            updateProgress() {
                if (this.currentStep > 0) {
                    const node = this.nodes.find(n => n.step === this.currentStep);
                    document.getElementById('currentStep').textContent = 
                        `Step ${this.currentStep}/${this.nodes.length}: ${node.label.replace(/\n/g, ' ')}`;
                    
                    document.querySelectorAll('.node').forEach(n => n.classList.remove('current-node'));
                    const currentNode = document.querySelector(`[data-step="${this.currentStep}"]`);
                    if (currentNode) currentNode.classList.add('current-node');
                }
            }
            
            toggleFullText() {
                this.fullTextVisible = !this.fullTextVisible;
                const button = document.getElementById('toggleFullText');
                button.textContent = this.fullTextVisible ? 'Hide Full Script' : 'Show Full Script';
                button.classList.toggle('active', this.fullTextVisible);
                document.getElementById('fullTextDisplay').style.display = this.fullTextVisible ? 'block' : 'none';
                
                if (!this.fullTextVisible) {
                    document.getElementById('fullTextDisplay').classList.remove('highlighting');
                    document.querySelectorAll('.text-segment').forEach(segment => {
                        segment.classList.remove('active');
                    });
                }
            }
            
            exportMermaid() {
                let mermaidCode = 'flowchart LR\n';
                
                this.nodes.forEach(node => {
                    const label = node.label.replace(/\n/g, '<br/>');
                    mermaidCode += `    ${node.id}["${label}"]\n`;
                });
                
                mermaidCode += '\n';
                
                this.arrows.forEach(arrow => {
                    if (arrow.curved) {
                        mermaidCode += `    ${arrow.from} -.-> ${arrow.to}\n`;
                    } else {
                        mermaidCode += `    ${arrow.from} --> ${arrow.to}\n`;
                    }
                });
                
                mermaidCode += '\n%% Styling\n';
                this.sections.forEach(section => {
                    mermaidCode += `classDef ${section.id} fill:${section.fillColor},stroke:${section.color},stroke-width:3px,color:#fff\n`;
                });
                
                mermaidCode += '\n';
                this.sections.forEach(section => {
                    const sectionNodes = this.nodes.filter(n => n.section === section.id).map(n => n.id).join(',');
                    if (sectionNodes) {
                        mermaidCode += `class ${sectionNodes} ${section.id}\n`;
                    }
                });
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(mermaidCode).then(() => {
                        const button = document.getElementById('exportMermaid');
                        const originalText = button.textContent;
                        button.textContent = 'Copied to Clipboard!';
                        button.style.background = '#2d8a3e';
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.style.background = '';
                        }, 2000);
                    });
                }
                console.log('Mermaid Code:', mermaidCode);
            }
            
            loadNew() {
                // Show initial load section
                document.getElementById('initialLoadSection').classList.remove('hidden');
                
                // Hide diagram interface
                document.getElementById('controls').classList.remove('visible');
                document.getElementById('toggleControlsBtn').style.display = 'none';
                document.getElementById('progressIndicator').classList.remove('visible');
                document.getElementById('fullTextDisplay').style.display = 'none';
                document.getElementById('diagram').innerHTML = `
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                        </marker>
                    </defs>
                `;
                
                this.clearError();
                this.fullTextVisible = false;
                this.currentStep = 0;
                this.data = null;
                this.controlsVisible = true;
            }
            
            showInterface() {
                // Hide initial load section
                document.getElementById('initialLoadSection').classList.add('hidden');
                
                // Show diagram interface
                document.getElementById('controls').classList.add('visible');
                document.getElementById('toggleControlsBtn').style.display = 'flex';
                document.getElementById('progressIndicator').classList.add('visible');
            }
            
            generateSampleJSON() {
                this.sampleData = {
                    title: "AI Semantic Transformation - Sequential Diagram",
                    sections: [
                        {
                            id: "paragraph1",
                            name: "Foundation",
                            color: "#4a9eff",
                            fillColor: "#1a5fb4"
                        },
                        {
                            id: "paragraph2", 
                            name: "Capability",
                            color: "#46d160",
                            fillColor: "#2d8a3e"
                        },
                        {
                            id: "paragraph3",
                            name: "Impact",
                            color: "#ff6b6b",
                            fillColor: "#c92a2a"
                        }
                    ],
                    nodes: [
                        {
                            id: "p1-1",
                            label: "Current AI\\nDiscourse",
                            section: "paragraph1",
                            text: "AI is often framed as either a sophisticated tool for specific tasks or an intelligent collaborator.",
                            step: 1
                        },
                        {
                            id: "p1-2", 
                            label: "Overlooked\\nCapability",
                            section: "paragraph1",
                            text: "This perspective overlooks AI's capability to function as a powerful semantic transformation layer.",
                            step: 2
                        },
                        {
                            id: "p1-3",
                            label: "Semantic\\nTransformation",
                            section: "paragraph1",
                            text: "AI can fundamentally alter the representation of existing information for diverse contexts.",
                            step: 3
                        },
                        {
                            id: "p2-1",
                            label: "Ladder of\\nAbstraction", 
                            section: "paragraph2",
                            text: "AI can understand and manipulate information at various levels of abstraction.",
                            step: 4
                        },
                        {
                            id: "p3-1",
                            label: "Fundamental\\nShift",
                            section: "paragraph3", 
                            text: "AI enables a fundamental shift in our interaction with information.",
                            step: 5
                        },
                        {
                            id: "p3-2",
                            label: "Actionable\\nIntelligence",
                            section: "paragraph3",
                            text: "Turns information overload into actionable intelligence through augmented understanding.",
                            step: 6
                        }
                    ],
                    arrows: [
                        {from: "p1-1", to: "p1-2"},
                        {from: "p1-2", to: "p1-3"},
                        {from: "p1-3", to: "p2-1"},
                        {from: "p2-1", to: "p3-1", curved: true},
                        {from: "p3-1", to: "p3-2"}
                    ],
                    fullText: [
                        {
                            id: "paragraph1",
                            segments: [
                                {
                                    nodeId: "p1-1",
                                    text: "The current discourse around AI often frames it as either a sophisticated tool for specific tasks or an intelligent collaborator."
                                },
                                {
                                    nodeId: "p1-2", 
                                    text: "While true, this perspective overlooks a more profound capability: AI, particularly Large Language Models, can function as a powerful semantic transformation layer for information."
                                },
                                {
                                    nodeId: "p1-3",
                                    text: "Instead of just processing data or generating new content based on prompts, it can fundamentally alter the representation of existing information, making it more accessible, relevant, and useful for human cognition in diverse contexts."
                                }
                            ]
                        },
                        {
                            id: "paragraph2",
                            segments: [
                                {
                                    nodeId: "p2-1",
                                    text: "This transformative power stems from AI's ability to understand and manipulate information at various levels of abstraction, akin to climbing a ladder of abstraction."
                                }
                            ]
                        },
                        {
                            id: "paragraph3", 
                            segments: [
                                {
                                    nodeId: "p3-1",
                                    text: "The ultimate impact of viewing AI as a data transformation layer is a fundamental shift in our interaction with information."
                                },
                                {
                                    nodeId: "p3-2",
                                    text: "It moves beyond simply offloading tasks to AI and instead empowers us to navigate and comprehend complex information landscapes with unprecedented ease, effectively turning information overload into actionable intelligence."
                                }
                            ]
                        }
                    ]
                };
            }
            
            downloadSample(e) {
                e.preventDefault();
                const dataStr = JSON.stringify(this.sampleData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'sample-diagram.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            toggleControls() {
                this.controlsVisible = !this.controlsVisible;
                const controls = document.getElementById('controls');
                const btn = document.getElementById('toggleControlsBtn');
                if (this.controlsVisible) {
                    controls.classList.add('visible');
                    btn.innerHTML = '✖️';
                    btn.title = 'Hide Controls';
                } else {
                    controls.classList.remove('visible');
                    btn.innerHTML = '⚙️';
                    btn.title = 'Show Controls';
                }
            }
        }
        
        // Initialize the application
        const app = new SequentialDiagramGenerator();
    </script>
</body>
</html>